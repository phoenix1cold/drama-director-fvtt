<div class="dd-cutin-layout">

  <!-- ═══ ЛЕВАЯ КОЛОНКА ════════════════════════════════════════════════════ -->
  <div class="dd-cutin-left">

    <!-- Пресеты -->
    <section class="dd-section">
      <h3><i class="fas fa-bookmark"></i> Пресеты</h3>
      <div class="dd-row">
        <select id="dd-preset-select" class="dd-select">
          <option value="">— Выбрать пресет —</option>
          {{#each presets}}<option value="{{this}}">{{this}}</option>{{/each}}
        </select>
        <button type="button" data-action="dd-preset-load" title="Загрузить"><i class="fas fa-upload"></i></button>
        <button type="button" data-action="dd-preset-delete" title="Удалить" class="dd-btn-danger"><i class="fas fa-trash"></i></button>
      </div>
      <div class="dd-row">
        <input type="text" id="dd-preset-name" placeholder="Название пресета…" class="dd-input" value="{{data._name}}"/>
        <button type="button" data-action="dd-preset-save"><i class="fas fa-save"></i> Сохранить</button>
      </div>
    </section>

    <!-- Тема -->
    <section class="dd-section">
      <h3><i class="fas fa-palette"></i> Тема и вид</h3>
      <select id="dd-theme-select" class="dd-select" style="margin-bottom:6px">
        <optgroup label="── Текстовые Cut-In ──">
          {{#each themes}}
          <option value="{{this.id}}" {{#if (eq ../data.theme this.id)}}selected{{/if}}>{{this.label}}</option>
          {{/each}}
        </optgroup>
        <optgroup label="── Персонаж-интро ──">
          {{#each introThemes}}
          <option value="{{this.id}}" {{#if (eq ../data.theme this.id)}}selected{{/if}}>{{this.label}}</option>
          {{/each}}
        </optgroup>
      </select>

      <div class="dd-row dd-row-pair">
        <label>Формат</label>
        <select id="dd-format-select" class="dd-select">
          <option value="popout" {{#if (eq data.format "popout")}}selected{{/if}}>Popout (вылет)</option>
          <option value="boxed"  {{#if (eq data.format "boxed") }}selected{{/if}}>Boxed (в рамке)</option>
        </select>
      </div>

      <div class="dd-row dd-row-pair">
        <label>Акцент</label>
        <input type="color" id="dd-color" value="{{data.color}}" class="dd-color"/>
        <label style="margin-left:6px">Шрифт</label>
        <input type="text" id="dd-font" value="{{data.fontFamily}}" class="dd-input" placeholder="Teko"/>
      </div>

      <div class="dd-row dd-row-pair">
        <label>Длительность (с)</label>
        <input type="number" id="dd-duration" value="{{data.customDuration}}" min="0.5" max="30" step="0.5" class="dd-input-sm"/>
        <label style="margin-left:6px">Затемн.</label>
        <input type="range" id="dd-dim" value="{{data.dimIntensity}}" min="0" max="1" step="0.05" style="flex:1"/>
      </div>

      <!-- Скрыть элементы темы -->
      <div class="dd-hide-row">
        <span class="dd-hide-label">Скрыть:</span>
        <label class="dd-check-badge" title="Скрыть фоновое изображение/фигуру темы">
          <input type="checkbox" id="dd-hide-bg" {{#if data.hideBackground}}checked{{/if}}/>
          <span>Фон</span>
        </label>
        <label class="dd-check-badge" title="Скрыть основной текст">
          <input type="checkbox" id="dd-hide-main-text" {{#if data.hideMainText}}checked{{/if}}/>
          <span>Текст</span>
        </label>
        <label class="dd-check-badge" title="Скрыть подпись">
          <input type="checkbox" id="dd-hide-sub-text" {{#if data.hideSubText}}checked{{/if}}/>
          <span>Подпись</span>
        </label>
        <label class="dd-check-badge" title="Скрыть декоративную рамку темы">
          <input type="checkbox" id="dd-hide-border" {{#if data.hideBorder}}checked{{/if}}/>
          <span>Рамку</span>
        </label>
      </div>
    </section>

    <!-- Позиция блока -->
    <section class="dd-section">
      <h3><i class="fas fa-arrows-alt"></i> Позиция блока</h3>
      <div class="dd-row dd-row-pair">
        <label>Вертикаль %</label>
        <input type="number" id="dd-screen-y" value="{{data.screenPos}}" min="0" max="100" class="dd-input-sm"/>
        <label style="margin-left:6px">Горизонталь %</label>
        <input type="number" id="dd-screen-x" value="{{data.screenPosX}}" min="0" max="100" class="dd-input-sm"/>
      </div>
    </section>

    <!-- Макрос -->
    <section class="dd-section">
      <h3><i class="fas fa-code"></i> Макрос</h3>
      <p class="dd-hint">Скопируйте готовый код — вставьте в макрос Foundry.</p>
      <button type="button" data-action="dd-macro-copy" class="dd-btn-wide">
        <i class="fas fa-copy"></i> Скопировать код макроса
      </button>
    </section>

    <!-- Кнопки показа -->
    <div class="dd-actions">
      <button type="button" data-action="dd-cutin-stop" class="dd-btn-stop">
        <i class="fas fa-stop"></i> Стоп
      </button>
      <button type="button" data-action="dd-cutin-play" class="dd-btn-play">
        <i class="fas fa-play"></i> Показать всем
      </button>
    </div>

  </div>

  <!-- ═══ ПРАВАЯ КОЛОНКА ═══════════════════════════════════════════════════ -->
  <div class="dd-cutin-right">

    <!-- Вкладки правой колонки -->
    <div class="dd-right-tabs">
      <button type="button" class="dd-rtab active" data-rtab="text"><i class="fas fa-font"></i> Текст</button>
      <button type="button" class="dd-rtab" data-rtab="char"><i class="fas fa-portrait"></i> Персонаж</button>
      <button type="button" class="dd-rtab" data-rtab="sound"><i class="fas fa-volume-up"></i> Звук</button>
      <button type="button" class="dd-rtab" data-rtab="layers"><i class="fas fa-layer-group"></i> Слои{{#if layers}} ({{layers.length}}){{/if}}</button>
    </div>

    <!-- TAB: Текст -->
    <div class="dd-rtab-content" data-rtab-content="text">
      <section class="dd-section">
        <h3><i class="fas fa-align-left"></i> Основной текст</h3>
        <textarea id="dd-text-main" rows="3" class="dd-textarea">{{data.text}}</textarea>
        <div class="dd-params-grid">
          <label class="dd-param-group">
            <span>Размер (rem)</span>
            <input type="number" id="dd-main-size" value="{{data.mainFontSize}}" min="1" max="40" step="0.5" class="dd-input-sm"/>
          </label>
          <label class="dd-param-group">
            <span>Цвет</span>
            <input type="color" id="dd-main-color" value="{{data.mainTextColor}}" class="dd-color"/>
          </label>
          <label class="dd-param-group">
            <span>Сдвиг X (px)</span>
            <input type="number" id="dd-main-ox" value="{{data.mainOffsetX}}" step="5" class="dd-input-sm"/>
          </label>
          <label class="dd-param-group">
            <span>Сдвиг Y (px)</span>
            <input type="number" id="dd-main-oy" value="{{data.mainOffsetY}}" step="5" class="dd-input-sm"/>
          </label>
        </div>
      </section>

      <section class="dd-section" style="margin-top:8px">
        <h3><i class="fas fa-align-right"></i> Подпись (sub text)</h3>
        <textarea id="dd-text-sub" rows="2" class="dd-textarea">{{data.subText}}</textarea>
        <div class="dd-params-grid">
          <label class="dd-param-group">
            <span>Размер (rem)</span>
            <input type="number" id="dd-sub-size" value="{{data.subFontSize}}" min="0.5" max="20" step="0.5" class="dd-input-sm"/>
          </label>
          <label class="dd-param-group">
            <span>Цвет</span>
            <input type="color" id="dd-sub-color" value="{{data.subTextColor}}" class="dd-color"/>
          </label>
          <label class="dd-param-group">
            <span>Сдвиг X (px)</span>
            <input type="number" id="dd-sub-ox" value="{{data.subOffsetX}}" step="5" class="dd-input-sm"/>
          </label>
          <label class="dd-param-group">
            <span>Сдвиг Y (px)</span>
            <input type="number" id="dd-sub-oy" value="{{data.subOffsetY}}" step="5" class="dd-input-sm"/>
          </label>
        </div>
      </section>
    </div>

    <!-- TAB: Персонаж -->
    <div class="dd-rtab-content dd-hidden" data-rtab-content="char">
      <section class="dd-section">
        <h3><i class="fas fa-image"></i> Изображение персонажа</h3>
        <p class="dd-hint">Основное изображение поверх фона темы. Поддерживаются .png, .webp, .webm, .mp4</p>
        <div class="dd-row" style="margin-bottom:10px">
          <input type="text" id="dd-img" value="{{data.img}}" placeholder="Путь к файлу…" class="dd-input"/>
          <button type="button" data-action="dd-browse-img" title="Выбрать файл"><i class="fas fa-folder-open"></i></button>
        </div>
        <h3 style="margin-top:4px"><i class="fas fa-sliders-h"></i> Трансформация персонажа</h3>
        <div class="dd-params-grid">
          <label class="dd-param-group">
            <span>Масштаб</span>
            <input type="number" id="dd-char-scale" value="{{data.charScale}}" min="0.01" max="10" step="0.05" class="dd-input-sm"/>
          </label>
          <label class="dd-param-group">
            <span>Сдвиг X (px)</span>
            <input type="number" id="dd-char-ox" value="{{data.charOffsetX}}" step="10" class="dd-input-sm"/>
          </label>
          <label class="dd-param-group">
            <span>Сдвиг Y (px)</span>
            <input type="number" id="dd-char-oy" value="{{data.charOffsetY}}" step="10" class="dd-input-sm"/>
          </label>
          <label class="dd-param-group">
            <span>Поворот °</span>
            <input type="number" id="dd-char-rot" value="{{data.charRotation}}" min="-360" max="360" step="5" class="dd-input-sm"/>
          </label>
          <label class="dd-param-group dd-param-check">
            <input type="checkbox" id="dd-char-mirror" {{#if data.charMirror}}checked{{/if}}/>
            <span>Зеркало по X</span>
          </label>
        </div>
      </section>
    </div>

    <!-- TAB: Звук -->
    <div class="dd-rtab-content dd-hidden" data-rtab-content="sound">
      <section class="dd-section">
        <h3><i class="fas fa-music"></i> Звуковое сопровождение</h3>
        <p class="dd-hint">По умолчанию играет звук выбранной темы. Включите галочку чтобы задать свой файл.</p>
        <div class="dd-row dd-row-pair" style="margin-bottom:8px">
          <label>
            <input type="checkbox" id="dd-custom-sound" {{#if data.customSound}}checked{{/if}}/>
            Использовать свой звук
          </label>
        </div>
        <div class="dd-row">
          <input type="text" id="dd-sound-path" value="{{data.soundPath}}"
            placeholder="Авто (звук темы)" class="dd-input"
            {{#unless data.customSound}}disabled{{/unless}}/>
          <button type="button" data-action="dd-browse-sound" title="Выбрать звук"><i class="fas fa-folder-open"></i></button>
        </div>
      </section>
    </div>

    <!-- TAB: Слои -->
    <div class="dd-rtab-content dd-hidden" data-rtab-content="layers">
      <div class="dd-layers-header">
        <p class="dd-hint" style="margin:0;flex:1">Кастомные изображения поверх фона темы. Каждый слой — отдельный файл с позицией, масштабом и режимом наложения.</p>
        <button type="button" data-action="dd-layer-add" class="dd-btn-add-layer">
          <i class="fas fa-plus"></i> Добавить слой
        </button>
      </div>

      {{#if layers}}
      <div class="dd-layers-list">
        {{#each layers}}
        <div class="dd-layer-row" data-layer-idx="{{this._idx}}">
          <div class="dd-layer-top">
            <div class="dd-layer-order-btns">
              <button type="button" data-layer-action="up" title="Вверх">↑</button>
              <span class="dd-layer-num">{{this._num}}</span>
              <button type="button" data-layer-action="down" title="Вниз">↓</button>
            </div>
            <input type="text" class="dd-layer-src dd-input" value="{{this.src}}" placeholder="Путь к изображению/видео…"/>
            <button type="button" data-layer-action="browse" title="Выбрать файл"><i class="fas fa-folder-open"></i></button>
            <button type="button" data-layer-action="remove" title="Удалить слой" class="dd-btn-danger"><i class="fas fa-times"></i></button>
          </div>
          <div class="dd-layer-params">
            <label class="dd-param-group"><span>X</span>
              <input type="number" class="dd-layer-x dd-input-sm" value="{{this.x}}" step="10"/>
            </label>
            <label class="dd-param-group"><span>Y</span>
              <input type="number" class="dd-layer-y dd-input-sm" value="{{this.y}}" step="10"/>
            </label>
            <label class="dd-param-group"><span>Z-слой</span>
              <input type="number" class="dd-layer-z dd-input-sm" value="{{this.z}}" min="0" max="100"/>
            </label>
            <label class="dd-param-group"><span>Масштаб</span>
              <input type="number" class="dd-layer-scale dd-input-sm" value="{{this.scale}}" min="0.01" max="20" step="0.05"/>
            </label>
            <label class="dd-param-group"><span>Угол °</span>
              <input type="number" class="dd-layer-rot dd-input-sm" value="{{this.rotation}}" min="-360" max="360" step="5"/>
            </label>
            <label class="dd-param-group"><span>Прозрачн.</span>
              <input type="number" class="dd-layer-opacity dd-input-sm" value="{{this.opacity}}" min="0" max="1" step="0.05"/>
            </label>
            <label class="dd-param-group"><span>Наложение</span>
              <select class="dd-layer-blend dd-select-sm">
                <option value="normal"      {{#if (eq this.blend "normal")     }}selected{{/if}}>Обычный</option>
                <option value="multiply"    {{#if (eq this.blend "multiply")   }}selected{{/if}}>Умножение</option>
                <option value="screen"      {{#if (eq this.blend "screen")     }}selected{{/if}}>Экран</option>
                <option value="overlay"     {{#if (eq this.blend "overlay")    }}selected{{/if}}>Перекрытие</option>
                <option value="add"         {{#if (eq this.blend "add")        }}selected{{/if}}>Сложение</option>
                <option value="lighten"     {{#if (eq this.blend "lighten")    }}selected{{/if}}>Осветление</option>
                <option value="darken"      {{#if (eq this.blend "darken")     }}selected{{/if}}>Затемнение</option>
                <option value="color-dodge" {{#if (eq this.blend "color-dodge")}}selected{{/if}}>Осветл.цвета</option>
                <option value="color-burn"  {{#if (eq this.blend "color-burn") }}selected{{/if}}>Затемн.цвета</option>
              </select>
            </label>
            <label class="dd-param-group dd-param-check">
              <input type="checkbox" class="dd-layer-mirror" {{#if this.mirror}}checked{{/if}}/>
              <span>Зеркало</span>
            </label>
            <label class="dd-param-group dd-param-check">
              <input type="checkbox" class="dd-layer-visible" {{#if this.visible}}checked{{/if}}/>
              <span>Показывать</span>
            </label>
          </div>
        </div>
        {{/each}}
      </div>
      {{else}}
      <div class="dd-empty-layers">
        <i class="fas fa-layer-group" style="font-size:2em;opacity:.25;display:block;text-align:center;margin-bottom:8px"></i>
        <p style="text-align:center;color:#777;margin:0">Слои не добавлены</p>
        <p class="dd-hint" style="text-align:center">Нажмите «Добавить слой» чтобы наложить собственные изображения поверх фона темы</p>
      </div>
      {{/if}}
    </div>

  </div>
</div>
